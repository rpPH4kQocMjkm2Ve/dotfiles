#!/bin/bash


set -e  

echo "Checking AUR helper..."
if ! command -v yay &> /dev/null; then
    echo "Yay not found. Installing..."
    sudo pacman -S --needed base-devel git
    git clone https://aur.archlinux.org/yay.git /tmp/yay
    cd /tmp/yay
    makepkg -si 
    cd -
    rm -rf /tmp/yay
fi

# --- 1. Pacman ---
NATIVE_PKGS=(
    # === SYSTEM & HYPRLAND ===
    "hyprland"
    "xdg-desktop-portal-hyprland"
    "xdg-desktop-portal-gtk"
    "xorg-xwayland"
    "waybar"
    "hyprpaper"
    "wofi"
    "hyprpolkitagent"
    "gnome-keyring"
    "hypridle"
    "hyprlock"
    "hyprsunset"
    "zram-generator"
    "libnotify"
    "openssh"
    "btrbk"
    "qt5ct"
    "qt6ct"
    "ukify" #atomic
    "firewalld"
    "uwsm"
    {{- if eq .laptop true }}
    "brightnessctl"
    "tpm2-tss" 
    "tpm2-tools"
    "bluez"
    "bluez-utils"
    "libfdk-aac"
    "libldac"
    {{- end }}

    # === AUDIO & VIDEO ===
    "pipewire"
    "pipewire-pulse"
    "pipewire-alsa"
    "wireplumber"
    "mpd"
    "ncmpcpp"
    "mpv"
    "obs-studio"
    "ffmpegthumbnailer"

    # === INPUT & FONTS ===
    "fcitx5-im"
    "fcitx5-kkc"
    "ttf-hack"
    "otf-ipafont"
    "otf-font-awesome"
    "noto-fonts-cjk"
    "ttf-jetbrains-mono-nerd"
    "ttf-font-awesome"
    "noto-fonts-emoji"

    # === APPS ===
    "kitty"
    "thunar"
    "nextcloud-client"
    "keepassxc"
    "qbittorrent"
    "gimp"
    "krita"
    "flatpak"
    "anki"

    # === CLI & TOOLS ===
    "neovim"
    "zsh"
    "fzf"
    "ripgrep"
    "fd"
    "bat"
    "eza"
    "zoxide"
    "unzip"
    "7zip"
    "man-db"
    "git"
    "htop"
    "wl-clipboard"
    "grim"
    "slurp"
    "lf"
    "rsync"
    "rclone"
    "restic"
    "syncthing"
    "wget"
    "reflector"
    "pacman-contrib"
    "udisks2"
    "strace"
    "imv"
    "swappy"
    "git-delta"
    "lazygit"
    "zsh-autosuggestions" 
    "zsh-syntax-highlighting"
    "bind"
    "imagemagick"
    "git-filter-repo"
    "lego"
    "dnsproxy"

    # === DEV & VIRTUALIZATION ===
    "base-devel"
    "go"
    "podman"
    "podman-compose"
    {{- if eq .virt_manager true }}
    "qemu-base"
    "virt-manager"
    "dnsmasq"
    {{- end }}
    "ansible"
    "ansible-lint"
    "age"
    "sops"
    "direnv"

    {{- if eq .nvidia true }}
    # === NVIDIA ===
    "nvidia-open"
    "nvidia-settings"
    "nvidia-utils"
    "libva-nvidia-driver"
    {{- end }}
    
    # === THEMES ===
    "materia-gtk-theme"
    "papirus-icon-theme"
    "kvantum"
)

# --- 2. AUR ---
AUR_PKGS=(
    "kopia-bin"
    {{- if eq .tablet true }}
    "opentabletdriver"
    {{- end }}
    {{- if eq .goldendict true }}
    "goldendict-ng"
    {{- end }}
    "coolercontrol-bin"
)

FLATPAK_PKGS=(
    "com.github.tchx84.Flatseal"
    "org.mozilla.firefox"
    "org.telegram.desktop"
    "org.libreoffice.LibreOffice"
    "org.gnome.Papers"
    "org.qownnotes.QOwnNotes"
    "org.localsend.localsend_app"
    {{- if eq .portproton true }}
    "ru.linux_gaming.PortProton"
    "runtime/org.freedesktop.Platform.VulkanLayer.gamescope/x86_64/25.08"
    {{- end }}
)

echo "--- Installing Native Packages ---"
sudo pacman -S --needed "${NATIVE_PKGS[@]}"

echo "--- Installing AUR Packages ---"
yay -S --needed "${AUR_PKGS[@]}"

echo "--- Flatpak ---"
flatpak install "${FLATPAK_PKGS[@]}"

echo "Done"
