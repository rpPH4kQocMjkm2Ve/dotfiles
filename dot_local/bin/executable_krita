#!/usr/bin/env bash
# Sandboxed Krita via bubblewrap (XWayland)
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

KRITA_CONF="${HOME}/.local/share/krita-config"
mkdir -p "$KRITA_CONF" \
         "${HOME}/.local/share/krita" \
         "${HOME}/.cache/krita" \
         "${HOME}/Pictures" \
         "${HOME}/Downloads"

FILE_BINDS=()
ARGS=()
bwrap_resolve_files FILE_BINDS ARGS --bind "$@"

OPT=(); bwrap_lib64 OPT
[[ -d "${HOME}/.local/share/fonts" ]] && \
    OPT+=(--ro-bind "${HOME}/.local/share/fonts" "${HOME}/.local/share/fonts")
GPU=(); bwrap_gpu GPU
X11=(); bwrap_x11 X11
AUDIO=(); bwrap_audio AUDIO
DBUS=(); bwrap_dbus_session DBUS
BASE=(); bwrap_base BASE OPT
ENV=(); bwrap_env_base ENV
ENV+=(--setenv QT_QPA_PLATFORM xcb --setenv QT_QPA_PLATFORMTHEME qt6ct)
SANDBOX=(); bwrap_sandbox SANDBOX yes

exec bwrap \
    "${BASE[@]}" \
    "${GPU[@]}" \
    --perms 0755 --dir /run/user \
    --perms 0700 --dir "${XDG_RUNTIME_DIR}" \
    --dir "${HOME}" \
    --bind "$KRITA_CONF"                      "${HOME}/.config" \
    --ro-bind-try "${HOME}/.config/fontconfig" "${HOME}/.config/fontconfig" \
    --ro-bind-try "${HOME}/.config/qt6ct"      "${HOME}/.config/qt6ct" \
    --ro-bind-try "${HOME}/.config/Kvantum"    "${HOME}/.config/Kvantum" \
    --bind "${HOME}/.local/share/krita"        "${HOME}/.local/share/krita" \
    --bind "${HOME}/.cache/krita"              "${HOME}/.cache/krita" \
    --bind "${HOME}/Pictures"                  "${HOME}/Pictures" \
    --bind "${HOME}/Downloads"                 "${HOME}/Downloads" \
    "${FILE_BINDS[@]}" \
    "${X11[@]}" \
    "${AUDIO[@]}" \
    "${DBUS[@]}" \
    "${ENV[@]}" \
    "${SANDBOX[@]}" \
    /usr/bin/krita "${ARGS[@]}"
