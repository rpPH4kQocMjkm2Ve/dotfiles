#!/usr/bin/env bash
# Sandboxed Krita via bubblewrap (XWayland)
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

KRITA_CONF="${HOME}/.local/share/krita-config"
mkdir -p "$KRITA_CONF" \
         "${HOME}/.local/share/krita" \
         "${HOME}/.cache/krita" \
         "${HOME}/Pictures" \
         "${HOME}/Downloads"

FILE_BINDS=()
ARGS=()
bwrap_resolve_files FILE_BINDS ARGS --bind "$@"

A=()
bwrap_base A
bwrap_lib64 A
[[ -d "${HOME}/.local/share/fonts" ]] && \
    A+=(--ro-bind "${HOME}/.local/share/fonts" "${HOME}/.local/share/fonts")
bwrap_gpu A

A+=(--perms 0755 --dir /run/user
    --perms 0700 --dir "${XDG_RUNTIME_DIR}"
    --dir "${HOME}"
    --bind "$KRITA_CONF"                      "${HOME}/.config"
    --ro-bind-try "${HOME}/.config/fontconfig" "${HOME}/.config/fontconfig"
    --ro-bind-try "${HOME}/.config/qt6ct"      "${HOME}/.config/qt6ct"
    --ro-bind-try "${HOME}/.config/Kvantum"    "${HOME}/.config/Kvantum"
    --bind "${HOME}/.local/share/krita"        "${HOME}/.local/share/krita"
    --bind "${HOME}/.cache/krita"              "${HOME}/.cache/krita"
    --bind "${HOME}/Pictures"                  "${HOME}/Pictures"
    --bind "${HOME}/Downloads"                 "${HOME}/Downloads"
    "${FILE_BINDS[@]}")

bwrap_x11 A
bwrap_audio A
bwrap_dbus_session A
bwrap_fcitx A
bwrap_env_base A
A+=(--setenv QT_QPA_PLATFORM xcb --setenv QT_QPA_PLATFORMTHEME qt6ct)
bwrap_sandbox A yes

exec bwrap "${A[@]}" -- /usr/bin/krita "${ARGS[@]}"
