#!/usr/bin/env python3
"""
Audio Device Switcher
Switches default audio output using wpctl + wofi
Usage: DEBUG=1 audio-device-switcher
"""

import os
import re
import shutil
import subprocess
import sys

DEBUG = os.environ.get("DEBUG", "0") == "1"


def debug(msg: str) -> None:
    if DEBUG:
        print(f"[DEBUG] {msg}", file=sys.stderr)


def check_dependencies() -> None:
    missing = [cmd for cmd in ("wpctl", "wofi") if not shutil.which(cmd)]

    if not shutil.which("notify-send"):
        debug("notify-send not found, will use stderr")

    if missing:
        print(f"Error: missing dependencies: {' '.join(missing)}", file=sys.stderr)
        sys.exit(1)

    r = subprocess.run(["wpctl", "status"], capture_output=True)
    if r.returncode != 0:
        print("Error: PipeWire is not running", file=sys.stderr)
        sys.exit(1)


def get_audio_sinks() -> list[dict]:
    """Parse wpctl status output into structured device list."""
    result = subprocess.run(
        ["wpctl", "status"],
        capture_output=True,
        text=True,
        env={**os.environ, "LC_ALL": "C"},
    )
    if result.returncode != 0:
        return []

    sinks = []
    in_audio = False
    in_sinks = False

    for line in result.stdout.splitlines():
        stripped = line.strip()

        # Track which top-level section we're in
        if re.match(r"^Audio\s*$", stripped):
            in_audio = True
            continue
        if re.match(r"^Video\s*$", stripped):
            break
        if not in_audio:
            continue

        # Track sub-sections within Audio
        bare = re.sub(r"[│├└─\s]", "", line)
        if bare.endswith(":"):
            in_sinks = bare == "Sinks:"
            continue

        if not in_sinks:
            continue

        # Parse device lines:  * 48. Device Name [vol: 0.80]
        cleaned = re.sub(r"[│├└─]", "", line).strip()
        if not cleaned:
            continue

        m = re.match(r"(\*?)\s*(\d+)\.\s+(.*)", cleaned)
        if m:
            sinks.append(
                {
                    "id": int(m.group(2)),
                    "name": m.group(3).strip(),
                    "default": m.group(1) == "*",
                }
            )

    return sinks


def show_menu(sinks: list[dict]) -> dict | None:
    """Show wofi menu, return chosen device or None."""
    lines = []
    for s in sinks:
        prefix = "✓" if s["default"] else " "
        lines.append(f"{prefix} {s['id']}. {s['name']}")

    try:
        r = subprocess.run(
            ["wofi", "-dmenu", "-p", "Select audio device"],
            input="\n".join(lines),
            capture_output=True,
            text=True,
        )
    except FileNotFoundError:
        return None

    if r.returncode != 0 or not r.stdout.strip():
        return None

    # Match the ID back to our structured data
    m = re.match(r"[✓\s]*(\d+)\.", r.stdout.strip())
    if not m:
        return None

    chosen_id = int(m.group(1))
    return next((s for s in sinks if s["id"] == chosen_id), None)


def notify(message: str) -> None:
    try:
        subprocess.run(
            ["notify-send", "-t", "2000", "Audio", message],
            capture_output=True,
        )
    except FileNotFoundError:
        print(message, file=sys.stderr)


def main() -> None:
    check_dependencies()

    # Log current device
    r = subprocess.run(
        ["wpctl", "inspect", "@DEFAULT_AUDIO_SINK@"],
        capture_output=True,
        text=True,
    )
    if r.returncode == 0:
        m = re.search(r'node\.nick\s*=\s*"([^"]*)"', r.stdout)
        if m:
            debug(f"Current device: {m.group(1)}")

    sinks = get_audio_sinks()
    if not sinks:
        print("Error: no audio devices found", file=sys.stderr)
        print("Try running: wpctl status", file=sys.stderr)
        sys.exit(1)

    debug(f"Found {len(sinks)} device(s)")
    for s in sinks:
        debug(f"  {'*' if s['default'] else ' '} {s['id']}. {s['name']}")

    chosen = show_menu(sinks)
    if chosen is None:
        debug("No device selected")
        sys.exit(0)

    debug(f"Switching to: {chosen['id']}. {chosen['name']}")

    r = subprocess.run(["wpctl", "set-default", str(chosen["id"])])
    if r.returncode == 0:
        notify(f"Switched to: {chosen['name']}")
    else:
        print("Error: failed to switch device", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
