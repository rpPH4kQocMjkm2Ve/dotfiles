#!/usr/bin/env bash

set -eo pipefail

trap '' PIPE 2>/dev/null || true
trap 'exit 130' INT TERM HUP

# ----------------------------------------------------------------------------
# Audio Device Switcher
# Switches default audio output using wpctl + wofi
# Usage: DEBUG=1 audio-device-switcher (for debug output)
# ----------------------------------------------------------------------------

DEBUG="${DEBUG:-0}"

debug() {
    [[ "$DEBUG" == "1" ]] && echo "[DEBUG] $*" >&2
    return 0
}

check_dependencies() {
    local missing=()
    for cmd in wpctl wofi; do
        if ! command -v "$cmd" &>/dev/null; then
            missing+=("$cmd")
        fi
    done
    
    if ! command -v notify-send &>/dev/null; then
        debug "notify-send not found, will use stderr"
    fi
    
    if ((${#missing[@]})); then
        echo "Error: missing dependencies: ${missing[*]}" >&2
        exit 1
    fi
    
    if ! wpctl status &>/dev/null; then
        echo "Error: PipeWire is not running" >&2
        exit 1
    fi
}

get_audio_devices() {
    local output
    if output=$(LC_ALL=C wpctl status 2>/dev/null); then
        echo "$output" | awk '
        /Audio/,/Video/ {
            if (/Sinks:/) { capture=1; next }
            if (/Sources:|Filters:|Streams:/) { capture=0 }
            if (capture && /^[[:space:]]*[│├└─ ]*\*?[[:space:]]*[0-9]+\./) {
                gsub(/[│├└─]/, "")
                gsub(/\*/, "✓ ")
                gsub(/^\s+/, "")
                gsub(/\s+$/, "")
                if (length > 0) print
            }
        }'
    else
        return 1
    fi
}

show_device_menu() {
    local result
    if result=$(wofi -dmenu -p "Select audio device" 2>/dev/null); then
        echo "$result"
    else
        return 1
    fi
}

extract_device_id() {
    local input="$1"
    if [[ -z "$input" ]]; then
        return 1
    fi
    local id
    id=$(echo "$input" | sed -n 's/^[[:space:]]*✓\?[[:space:]]*\([0-9]\+\).*/\1/p' | head -n1)
    if [[ -n "$id" ]]; then
        echo "$id"
    else
        return 1
    fi
}

main() {
    check_dependencies    

    local devices selected_device device_id current_device

    if current_device=$(wpctl inspect @DEFAULT_AUDIO_SINK@ 2>/dev/null); then
        current_device=$(echo "$current_device" | sed -n 's/.*node.nick = "\([^"]*\)".*/\1/p')
        debug "Current device: $current_device"
    else
        debug "Could not get current device"
    fi

    devices=$(get_audio_devices) || {
        echo "Error: no audio devices found or wpctl not working properly" >&2
        echo "Try running: wpctl status" >&2
        exit 1
    }
    debug "Devices: $devices"

    [[ -z "$devices" ]] && { echo "Error: no devices found" >&2; exit 1; }

    if ! selected_device=$(echo "$devices" | show_device_menu); then
        debug "User cancelled or wofi error"
        exit 0
    fi
    
    debug "Selected: '$selected_device'"
    [[ -z "$selected_device" ]] && { debug "No device selected"; exit 0; }

    if ! device_id=$(extract_device_id "$selected_device"); then
        echo "Error: could not extract device ID from: $selected_device" >&2
        exit 1
    fi
    debug "ID: '$device_id'"

    if [[ ! "$device_id" =~ ^[0-9]+$ ]]; then
        echo "Error: invalid device ID '$device_id'" >&2
        exit 1
    fi

    if wpctl set-default "$device_id"; then
        notify-send -t 2000 "Audio" "Switched to: ${selected_device#*. }" 2>/dev/null || \
            echo "Switched to: ${selected_device#*. }" >&2
    else
        echo "Error: failed to switch device" >&2
        exit 1
    fi
}

main "$@"
