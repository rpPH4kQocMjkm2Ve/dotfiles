#!/usr/bin/env bash
# Sandboxed qBittorrent via bubblewrap
set -euo pipefail

mkdir -p "${HOME}/.config/qBittorrent" \
         "${HOME}/.local/share/qBittorrent" \
         "${HOME}/.cache/qBittorrent" \
         "${HOME}/Downloads"

# ── Wayland ─────────────────────────────────────────────────────
WL=()
_wl="${XDG_RUNTIME_DIR:-}/${WAYLAND_DISPLAY:-}"
if [[ -S "$_wl" ]]; then
    WL+=(
        --ro-bind "$_wl" "$_wl"
        --setenv WAYLAND_DISPLAY "$WAYLAND_DISPLAY"
    )
fi

# ── D-Bus (for fcitx5, notifications) ──────────────────────────
DBUS=()
_bus="${DBUS_SESSION_BUS_ADDRESS:-}"
if [[ "$_bus" == unix:path=* ]]; then
    _bus_path="${_bus#unix:path=}"
    [[ -S "$_bus_path" ]] && DBUS+=(
        --ro-bind "$_bus_path" "$_bus_path"
        --setenv DBUS_SESSION_BUS_ADDRESS "$_bus"
    )
fi

# ── GPU ─────────────────────────────────────────────────────────
GPU=()
[[ -d /dev/dri ]] && GPU+=(--dev-bind /dev/dri /dev/dri)

# ── Conditional binds (outside $HOME) ───────────────────────────
OPT=()
if [[ -d /usr/lib64 && ! -L /usr/lib64 ]]; then
    OPT+=(--ro-bind /usr/lib64 /usr/lib64 --symlink /usr/lib64 /lib64)
else
    OPT+=(--symlink /usr/lib /lib64)
fi

if [[ -L /etc/resolv.conf ]]; then
    _rd="$(dirname "$(realpath /etc/resolv.conf)")"
    OPT+=(--ro-bind "$_rd" "$_rd")
fi

# ── Launch ──────────────────────────────────────────────────────
exec bwrap \
    --ro-bind /usr /usr          \
    "${OPT[@]}"                  \
    --symlink /usr/bin /bin      \
    --symlink /usr/bin /sbin     \
    --symlink /usr/lib /lib      \
    --proc /proc                 \
    --ro-bind /sys /sys          \
    --dev /dev                   \
    "${GPU[@]}"                  \
    --tmpfs /tmp                 \
    --tmpfs /dev/shm             \
    --ro-bind /etc /etc          \
    \
    --dir "${HOME}"              \
    --dir "${HOME}/.config"      \
    --bind "${HOME}/.config/qBittorrent"      "${HOME}/.config/qBittorrent"      \
    --bind "${HOME}/.local/share/qBittorrent" "${HOME}/.local/share/qBittorrent" \
    --bind "${HOME}/.cache/qBittorrent"       "${HOME}/.cache/qBittorrent"       \
    --bind "${HOME}/Downloads"                "${HOME}/Downloads"                \
    --ro-bind-try "${HOME}/.config/fontconfig" "${HOME}/.config/fontconfig" \
    --ro-bind-try "${HOME}/.config/qt6ct"      "${HOME}/.config/qt6ct"      \
    --ro-bind-try "${HOME}/.config/gtk-3.0"    "${HOME}/.config/gtk-3.0"    \
    --ro-bind-try "${HOME}/.config/Kvantum"    "${HOME}/.config/Kvantum"    \
    \
    --dir "${XDG_RUNTIME_DIR}"   \
    "${WL[@]}"                   \
    "${DBUS[@]}"                 \
    \
    --setenv HOME            "${HOME}"                \
    --setenv LANG            "${LANG:-en_US.UTF-8}"   \
    --setenv PATH            "/usr/bin:/bin"           \
    --setenv XDG_RUNTIME_DIR "${XDG_RUNTIME_DIR}"     \
    ${QT_QPA_PLATFORM:+--setenv QT_QPA_PLATFORM "$QT_QPA_PLATFORM"}                 \
    ${QT_QPA_PLATFORMTHEME:+--setenv QT_QPA_PLATFORMTHEME "$QT_QPA_PLATFORMTHEME"}   \
    \
    --unshare-all            \
    --share-net              \
    --new-session            \
    --die-with-parent        \
    /usr/bin/qbittorrent "$@"
