#!/bin/bash
# Sandboxed Anki via bubblewrap
set -euo pipefail

# Create host directories if they don't exist yet
mkdir -p "${HOME}/.local/share/Anki2" \
	 "${HOME}/Downloads/anki"

# ── Bind-mount files passed as arguments (.apkg, .ankiaddon) ────
FILE_BINDS=()
for arg in "$@"; do
    [[ "$arg" == -* ]] && continue
    if [[ -e "$arg" ]]; then
        _real="$(realpath "$arg")"
        _dir="$(dirname "$_real")"
        case "$_dir" in /usr/*|/etc/*|/proc/*|/dev/*|/tmp*|/sys/*) continue ;; esac
        FILE_BINDS+=(--ro-bind "$_dir" "$_dir")
    fi
done

# ── Wayland display ───────────────────────────────────────────────
WL=()
_wl="${XDG_RUNTIME_DIR:-}/${WAYLAND_DISPLAY:-}"
if [[ -S "$_wl" ]]; then
    WL+=(
        --ro-bind  "$_wl" "$_wl"
        --setenv   WAYLAND_DISPLAY "$WAYLAND_DISPLAY"
    )
fi

# ── Audio (PipeWire / PulseAudio) ─────────────────────────────────
AUDIO=()
_pw="${XDG_RUNTIME_DIR:-}/pipewire-0"
_pulse="${XDG_RUNTIME_DIR:-}/pulse"
[[ -S "$_pw" ]]    && AUDIO+=(--ro-bind "$_pw" "$_pw")
[[ -d "$_pulse" ]] && AUDIO+=(--ro-bind "$_pulse" "$_pulse")

# ── D-Bus ─────────────────────────────────────────────────────────
DBUS=()
_bus="${DBUS_SESSION_BUS_ADDRESS:-}"
if [[ "$_bus" == unix:path=* ]]; then
    _bus_path="${_bus#unix:path=}"
    [[ -S "$_bus_path" ]] && DBUS+=(
        --ro-bind "$_bus_path" "$_bus_path"
        --setenv  DBUS_SESSION_BUS_ADDRESS "$_bus"
    )
fi
_sys_bus="/run/dbus/system_bus_socket"
[[ -S "$_sys_bus" ]] && DBUS+=(--ro-bind "$_sys_bus" "$_sys_bus")

# ── GPU ───────────────────────────────────────────────────────────
GPU=()
[[ -d /dev/dri ]] && GPU+=(--dev-bind /dev/dri /dev/dri)

# ── Conditional binds ─────────────────────────────────────────────
OPT=()
if [[ -d /usr/lib64 && ! -L /usr/lib64 ]]; then
    OPT+=(--ro-bind /usr/lib64 /usr/lib64 --symlink /usr/lib64 /lib64)
else
    OPT+=(--symlink /usr/lib /lib64)
fi

if [[ -L /etc/resolv.conf ]]; then
    _rd="$(dirname "$(realpath /etc/resolv.conf)")"
    OPT+=(--ro-bind "$_rd" "$_rd")
fi

[[ -d "${HOME}/.config/qt6ct" ]]      && OPT+=(--ro-bind "${HOME}/.config/qt6ct"      "${HOME}/.config/qt6ct")
[[ -d "${HOME}/.config/qt5ct" ]]      && OPT+=(--ro-bind "${HOME}/.config/qt5ct"      "${HOME}/.config/qt5ct")
[[ -d "${HOME}/.config/gtk-3.0" ]]    && OPT+=(--ro-bind "${HOME}/.config/gtk-3.0"    "${HOME}/.config/gtk-3.0")
[[ -d "${HOME}/.config/fontconfig" ]] && OPT+=(--ro-bind "${HOME}/.config/fontconfig"  "${HOME}/.config/fontconfig")
[[ -d "${HOME}/.local/share/fonts" ]] && OPT+=(--ro-bind "${HOME}/.local/share/fonts"  "${HOME}/.local/share/fonts")

# .apkg export/import
[[ -d "${HOME}/Downloads/anki" ]] && OPT+=(--bind "${HOME}/Downloads/anki" "${HOME}/Downloads/anki")

# ── Launch ────────────────────────────────────────────────────────
exec bwrap \
    --ro-bind /usr/bin   /usr/bin   \
    --ro-bind /usr/lib   /usr/lib   \
    --ro-bind /usr/share /usr/share \
    "${OPT[@]}"                     \
    --symlink /usr/bin /bin         \
    --symlink /usr/bin /sbin        \
    --symlink /usr/lib /lib         \
    --proc /proc                    \
    --ro-bind /sys /sys             \
    --dev  /dev                     \
    "${GPU[@]}"                     \
    --tmpfs /tmp                    \
    --tmpfs /dev/shm                \
    --ro-bind /etc /etc             \
    \
    --dir     "${HOME}"                                                  \
    --dir     "${HOME}/.config"                                          \
    --bind    "${HOME}/.local/share/Anki2" "${HOME}/.local/share/Anki2"  \
    "${FILE_BINDS[@]}"                                                   \
    \
    --dir     "${XDG_RUNTIME_DIR}"  \
    "${WL[@]}"                      \
    "${AUDIO[@]}"                   \
    "${DBUS[@]}"                    \
    \
    --setenv HOME            "${HOME}"                    \
    --setenv LANG            "${LANG:-en_US.UTF-8}"       \
    --setenv PATH            "/usr/bin:/bin"               \
    --setenv XDG_RUNTIME_DIR "${XDG_RUNTIME_DIR}"         \
    --setenv QTWEBENGINE_DISABLE_SANDBOX 1                \
    ${QT_QPA_PLATFORM:+--setenv QT_QPA_PLATFORM "$QT_QPA_PLATFORM"}                 \
    ${QT_QPA_PLATFORMTHEME:+--setenv QT_QPA_PLATFORMTHEME "$QT_QPA_PLATFORMTHEME"}   \
    \
    --unshare-all                   \
    --share-net                     \
    --new-session                   \
    --die-with-parent               \
    /usr/bin/anki "$@"
