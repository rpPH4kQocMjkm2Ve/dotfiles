#!/usr/bin/env bash
# Sandboxed imv-dir via bubblewrap (native Wayland)
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

FILE_BINDS=()
ARGS=()
bwrap_resolve_files FILE_BINDS ARGS --ro-bind "$@"

A=()
bwrap_base A
bwrap_lib64 A
bwrap_gpu A

A+=(--perms 0755 --dir /run/user
    --perms 0700 --dir "${XDG_RUNTIME_DIR}"
    --dir "${HOME}"
    --ro-bind-try "${HOME}/.config/imv"        "${HOME}/.config/imv"
    --ro-bind-try "${HOME}/.config/fontconfig"  "${HOME}/.config/fontconfig"
    "${FILE_BINDS[@]}")

bwrap_wayland A
bwrap_env_base A
A+=(--setenv XDG_SESSION_TYPE "${XDG_SESSION_TYPE:-wayland}")
bwrap_hardened_malloc A default
bwrap_sandbox A

exec bwrap "${A[@]}" -- /usr/bin/imv-dir "${ARGS[@]}"
