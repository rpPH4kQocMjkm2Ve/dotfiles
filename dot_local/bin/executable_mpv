#!/usr/bin/env bash
# Sandboxed mpv via bubblewrap
set -euo pipefail

mkdir -p "$HOME/Pictures/Screenshots" \
         "$HOME/.local/state/mpv/watch_later" \
	 "$HOME/.cache/fontconfig"

# ── Resolve file arguments to real paths ────────────────────────
FILE_BINDS=()
ARGS=()
for arg in "$@"; do
    if [[ "$arg" != -* && -e "$arg" ]]; then
        _real="$(realpath "$arg")"
        _dir="$(dirname "$_real")"
        case "$_dir" in /usr/*|/etc/*|/proc/*|/dev/*|/tmp*|/sys/*) ;; *)
            FILE_BINDS+=(--ro-bind "$_dir" "$_dir")
        ;; esac
        ARGS+=("$_real")
    else
        ARGS+=("$arg")
    fi
done

# ── Wayland ─────────────────────────────────────────────────────
WL=()
_wl="${XDG_RUNTIME_DIR:-}/${WAYLAND_DISPLAY:-}"
if [[ -S "$_wl" ]]; then
    WL+=(
        --ro-bind "$_wl" "$_wl"
        --setenv WAYLAND_DISPLAY "$WAYLAND_DISPLAY"
    )
fi

# ── Audio ───────────────────────────────────────────────────────
AUDIO=()
_pw="${XDG_RUNTIME_DIR:-}/pipewire-0"
_pulse="${XDG_RUNTIME_DIR:-}/pulse"
[[ -S "$_pw" ]]    && AUDIO+=(--ro-bind "$_pw" "$_pw")
[[ -d "$_pulse" ]] && AUDIO+=(--ro-bind "$_pulse" "$_pulse")

# ── GPU + nvidia ────────────────────────────────────────────────
GPU=()
[[ -d /dev/dri ]] && GPU+=(--dev-bind /dev/dri /dev/dri)
for dev in /dev/nvidia{0,1,ctl,-modeset}; do
    [[ -e "$dev" ]] && GPU+=(--dev-bind "$dev" "$dev")
done

# ── D-Bus ───────────────────────────────────────────────────────
DBUS=()
_bus="${DBUS_SESSION_BUS_ADDRESS:-}"
if [[ "$_bus" == unix:path=* ]]; then
    _bus_path="${_bus#unix:path=}"
    [[ -S "$_bus_path" ]] && DBUS+=(
        --ro-bind "$_bus_path" "$_bus_path"
        --setenv DBUS_SESSION_BUS_ADDRESS "$_bus"
    )
fi

# ── Conditional system binds ────────────────────────────────────
OPT=()
if [[ -d /usr/lib64 && ! -L /usr/lib64 ]]; then
    OPT+=(--ro-bind /usr/lib64 /usr/lib64 --symlink /usr/lib64 /lib64)
else
    OPT+=(--symlink /usr/lib /lib64)
fi
if [[ -L /etc/resolv.conf ]]; then
    OPT+=(--ro-bind "$(dirname "$(realpath /etc/resolv.conf)")" \
                     "$(dirname "$(realpath /etc/resolv.conf)")")
fi

exec bwrap \
    --ro-bind /usr /usr \
    "${OPT[@]}" \
    --symlink /usr/bin /bin \
    --symlink /usr/bin /sbin \
    --symlink /usr/lib /lib \
    --proc /proc \
    --ro-bind /sys /sys \
    --dev /dev \
    "${GPU[@]}" \
    --tmpfs /tmp \
    --tmpfs /dev/shm \
    --ro-bind /etc /etc \
    \
    --tmpfs "${HOME}" \
    --ro-bind-try "${HOME}/.config/mpv" "${HOME}/.config/mpv" \
    --ro-bind-try "${HOME}/.config/fontconfig" "${HOME}/.config/fontconfig" \
    --ro-bind-try "${HOME}/.local/share/fonts" "${HOME}/.local/share/fonts" \
    --bind "${HOME}/.local/state/mpv" "${HOME}/.local/state/mpv" \
    --bind "${HOME}/Pictures/Screenshots" "${HOME}/Pictures/Screenshots" \
    --bind "${HOME}/.cache/fontconfig" "${HOME}/.cache/fontconfig" \
    "${FILE_BINDS[@]}" \
    \
    --perms 0700 --dir "${XDG_RUNTIME_DIR}" \
    "${WL[@]}" \
    "${AUDIO[@]}" \
    "${DBUS[@]}" \
    \
    --setenv HOME "${HOME}" \
    --setenv LANG "${LANG:-en_US.UTF-8}" \
    --setenv PATH "/usr/bin:/bin" \
    --setenv XDG_RUNTIME_DIR "${XDG_RUNTIME_DIR}" \
    --setenv WAYLAND_DISPLAY "${WAYLAND_DISPLAY:-wayland-1}" \
    \
    --unshare-all \
    --share-net \
    --new-session \
    --die-with-parent \
    /usr/bin/mpv "${ARGS[@]}"
