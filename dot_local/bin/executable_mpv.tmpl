#!/usr/bin/env bash
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

{{ $s := output "sops" "-d" (joinPath .chezmoi.sourceDir "secrets.enc.yaml") | fromYaml -}}
{{ $host := .chezmoi.hostname -}}
{{ $mpv := index $s "mpv" -}}
DATA_BINDS=()
{{ if hasKey $mpv $host -}}
{{ range $key, $path := index $mpv $host -}}
[[ -d "{{ $path }}" ]] && DATA_BINDS+=(--ro-bind "{{ $path }}" "{{ $path }}")
{{ end -}}
{{ end -}}

FILE_BINDS=(); ARGS=()
bwrap_resolve_files FILE_BINDS ARGS --ro-bind "$@"

A=()
bwrap_gui_setup A yes
bwrap_dbus_system A
bwrap_bind_dir A \
    "${HOME}/.config/mpv" \
    "${HOME}/.local/state/mpv/watch_later" \
    "${HOME}/.local/share/Anki2" \
    "${HOME}/Pictures/Screenshots" \
    "${HOME}/.cache/fontconfig"
A+=("${DATA_BINDS[@]}" "${FILE_BINDS[@]}")
bwrap_audio A
A+=(--setenv XDG_STATE_HOME "${HOME}/.local/state")
bwrap_gui_finish A wayland yes

exec bwrap "${A[@]}" -- /usr/bin/mpv "${ARGS[@]}"
