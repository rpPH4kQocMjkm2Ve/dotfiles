#!/usr/bin/env bash
# Sandboxed GIMP via bubblewrap
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

mkdir -p "${HOME}/.config/GIMP" \
         "${HOME}/.local/share/GIMP" \
         "${HOME}/.cache/GIMP" \
         "${HOME}/Pictures" \
         "${HOME}/Downloads"

FILE_BINDS=()
ARGS=()
bwrap_resolve_files FILE_BINDS ARGS --bind "$@"

OPT=(); bwrap_lib64 OPT
GPU=(); bwrap_gpu GPU
WL=(); bwrap_wayland WL
DBUS=(); bwrap_dbus_session DBUS
THEMES=(); bwrap_themes THEMES
BASE=(); bwrap_base BASE OPT
HOME_FS=(); bwrap_home_tmpfs HOME_FS
ENV=(); bwrap_env_base ENV
SANDBOX=(); bwrap_sandbox SANDBOX no

exec bwrap \
    "${BASE[@]}" \
    "${GPU[@]}" \
    --perms 0755 --dir /run/user \
    --perms 0700 --dir "${XDG_RUNTIME_DIR}" \
    "${HOME_FS[@]}" \
    --bind "${HOME}/.config/GIMP"      "${HOME}/.config/GIMP" \
    --bind "${HOME}/.local/share/GIMP" "${HOME}/.local/share/GIMP" \
    --bind "${HOME}/.cache/GIMP"       "${HOME}/.cache/GIMP" \
    --bind "${HOME}/Pictures"          "${HOME}/Pictures" \
    --bind "${HOME}/Downloads"         "${HOME}/Downloads" \
    "${FILE_BINDS[@]}" \
    "${THEMES[@]}" \
    "${WL[@]}" \
    "${DBUS[@]}" \
    "${ENV[@]}" \
    "${SANDBOX[@]}" \
    /usr/bin/gimp "${ARGS[@]}"
