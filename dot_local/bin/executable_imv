#!/usr/bin/env bash
# Sandboxed imv via bubblewrap (native Wayland)
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

FILE_BINDS=()
ARGS=()
bwrap_resolve_files FILE_BINDS ARGS --ro-bind "$@"

OPT=(); bwrap_lib64 OPT
GPU=(); bwrap_gpu GPU
WL=(); bwrap_wayland WL
BASE=(); bwrap_base BASE OPT
ENV=(); bwrap_env_base ENV
ENV+=(--setenv XDG_SESSION_TYPE "${XDG_SESSION_TYPE:-wayland}")
SANDBOX=(); bwrap_sandbox SANDBOX no

exec bwrap \
    "${BASE[@]}" \
    "${GPU[@]}" \
    --perms 0755 --dir /run/user \
    --perms 0700 --dir "${XDG_RUNTIME_DIR}" \
    --dir "${HOME}" \
    --ro-bind-try "${HOME}/.config/imv" "${HOME}/.config/imv" \
    --ro-bind-try "${HOME}/.config/fontconfig" "${HOME}/.config/fontconfig" \
    "${FILE_BINDS[@]}" \
    "${WL[@]}" \
    "${ENV[@]}" \
    "${SANDBOX[@]}" \
    /usr/bin/imv "${ARGS[@]}"
