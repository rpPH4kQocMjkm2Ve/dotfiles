#!/usr/bin/env bash
# Sandboxed GoldenDict-ng via bubblewrap (XWayland)
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

{{ $s := output "sops" "-d" (joinPath .chezmoi.sourceDir "secrets.enc.yaml") | fromYaml -}}
DICT_DIR="$(realpath -m -- "{{ index $s "goldendict" "dict_dir" }}")"
[[ -d "${DICT_DIR}" ]] || { echo "No dict dir: ${DICT_DIR}" >&2; exit 1; }

mkdir -p "${HOME}/.config/goldendict" \
         "${HOME}/.local/share/goldendict" \
         "${HOME}/.local/share/GoldenDict-ng" \
         "${HOME}/.cache/goldendict" \
         "${HOME}/.cache/fontconfig"

OPT=(); bwrap_lib64 OPT
GPU=(); bwrap_gpu GPU
X11=(); bwrap_x11 X11
AUDIO=(); bwrap_audio AUDIO
DBUS=(); bwrap_dbus_session DBUS
SYSBUS=(); bwrap_dbus_system SYSBUS
THEMES=(); bwrap_themes THEMES
BASE=(); bwrap_base BASE OPT
HOME_FS=(); bwrap_home_tmpfs HOME_FS
ENV=(); bwrap_env_base ENV
ENV+=(--setenv QT_QPA_PLATFORM xcb --setenv QT_QPA_PLATFORMTHEME qt6ct)
SANDBOX=(); bwrap_sandbox SANDBOX yes
FCITX=(); bwrap_fcitx FCITX

exec bwrap \
    "${BASE[@]}" \
    "${GPU[@]}" \
    "${SYSBUS[@]}" \
    --perms 0755 --dir /run/user \
    --perms 0700 --dir "${XDG_RUNTIME_DIR}" \
    "${HOME_FS[@]}" \
    --bind "${HOME}/.config/goldendict"         "${HOME}/.config/goldendict" \
    --bind "${HOME}/.local/share/goldendict"    "${HOME}/.local/share/goldendict" \
    --bind "${HOME}/.local/share/GoldenDict-ng" "${HOME}/.local/share/GoldenDict-ng" \
    --bind "${HOME}/.cache/goldendict"          "${HOME}/.cache/goldendict" \
    --bind "${HOME}/.cache/fontconfig"          "${HOME}/.cache/fontconfig" \
    --ro-bind "${DICT_DIR}" "${DICT_DIR}" \
    "${THEMES[@]}" \
    "${X11[@]}" \
    "${AUDIO[@]}" \
    "${DBUS[@]}" \
    "${FCITX[@]}" \
    "${ENV[@]}" \
    "${SANDBOX[@]}" \
    /usr/bin/goldendict "$@"
