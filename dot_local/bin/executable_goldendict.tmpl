#!/usr/bin/env bash
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

{{ $s := output "sops" "-d" (joinPath .chezmoi.sourceDir "secrets.enc.yaml") | fromYaml -}}
DICT_DIR="$(realpath -m -- "{{ index $s "goldendict" "dict_dir" }}")"
[[ -d "${DICT_DIR}" ]] || { echo "No dict dir: ${DICT_DIR}" >&2; exit 1; }

A=()
bwrap_gui_setup A yes
bwrap_dbus_system A
bwrap_bind_dir A bind \
    "${HOME}/.config/goldendict" \
    "${HOME}/.local/share/goldendict" \
    "${HOME}/.local/share/GoldenDict-ng" \
    "${HOME}/.cache/goldendict" \
    "${HOME}/.cache/fontconfig"
A+=(--ro-bind "${DICT_DIR}" "${DICT_DIR}")
bwrap_audio A
bwrap_fcitx A
A+=(--setenv QT_QPA_PLATFORM xcb --setenv QT_QPA_PLATFORMTHEME qt6ct)
bwrap_gui_finish A x11 yes no

exec bwrap "${A[@]}" -- /usr/bin/goldendict "$@"
