#!/usr/bin/env bash
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

{{ $s := output "sops" "-d" (joinPath .chezmoi.sourceDir "secrets.enc.yaml") | fromYaml -}}
DICT_DIR="{{ index $s "goldendict" "dict_dir" }}"
AUDIO_DIR="{{ index $s "goldendict" "audio_dir" }}"

A=()
bwrap_gui_setup A yes
bwrap_dbus_system A
bwrap_bind_dir A \
    "${HOME}/.config/goldendict" \
    "${HOME}/.local/share/goldendict" \
    "${HOME}/.local/share/GoldenDict-ng" \
    "${HOME}/.cache/goldendict" \
    "${HOME}/.cache/fontconfig"
require_dir "${DICT_DIR}"
bwrap_ro_bind_dir A "${DICT_DIR}" "${AUDIO_DIR}"
bwrap_audio A
bwrap_fcitx A
A+=(--setenv QT_QPA_PLATFORM xcb --setenv QT_QPA_PLATFORMTHEME qt6ct)
bwrap_gui_finish A x11 yes no

exec bwrap "${A[@]}" -- /usr/bin/goldendict "$@"
