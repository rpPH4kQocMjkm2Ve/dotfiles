#!/usr/bin/env bash
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

{{ $s := output "sops" "-d" (joinPath .chezmoi.sourceDir "secrets.enc.yaml") | fromYaml -}}
DB_DIR="$(realpath -m -- "{{ index $s "keepassxc" "db_dir" }}")"
[[ -d "${DB_DIR}" ]] || { echo "No DB dir: ${DB_DIR}" >&2; exit 1; }

A=()
bwrap_gui_setup A
bwrap_bind_dir A bind "${HOME}/.config/keepassxc" "${HOME}/.cache/keepassxc"
A+=(--bind "${DB_DIR}" "${DB_DIR}")
bwrap_fcitx A
A+=(--setenv QT_QPA_PLATFORMTHEME qt6ct)
bwrap_gui_finish A

exec bwrap "${A[@]}" -- /usr/bin/keepassxc "$@"
