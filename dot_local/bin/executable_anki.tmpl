#!/usr/bin/env bash
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

{{ $s := output "sops" "-d" (joinPath .chezmoi.sourceDir "secrets.enc.yaml") | fromYaml -}}
AUDIO_DIR="{{ index $s "anki" "audio_sources_dir" }}"

FILE_BINDS=(); ARGS=()
bwrap_resolve_files FILE_BINDS ARGS --ro-bind "$@"

A=()
bwrap_gui_setup A yes
bwrap_dbus_system A
bwrap_bind_dir A "${HOME}/.local/share/Anki2" "${HOME}/Downloads/anki"
bwrap_ro_bind_dir A "${AUDIO_DIR}"
A+=("${FILE_BINDS[@]}")
bwrap_audio A
A+=(--setenv QT_QPA_PLATFORM wayland
    --setenv QT_QPA_PLATFORMTHEME qt6ct
    --setenv QTWEBENGINE_DISABLE_SANDBOX 1)
bwrap_gui_finish A wayland yes no

exec bwrap "${A[@]}" -- /usr/bin/anki "${ARGS[@]}"
