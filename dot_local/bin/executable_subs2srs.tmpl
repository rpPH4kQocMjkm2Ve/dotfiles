#!/usr/bin/env bash
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

{{ $s := output "sops" "-d" (joinPath .chezmoi.sourceDir "secrets.enc.yaml") | fromYaml -}}
MEDIA_DIR="{{ index $s "subs2srs" "media_dir" }}"

CONF_DIR="${HOME}/.config/subs2srs"
OUTPUT_DIR="${HOME}/subs2srs"

mkdir -p "$CONF_DIR"
[[ -f "${CONF_DIR}/preferences.txt" ]] || \
    cp /opt/subs2srs/preferences.txt "${CONF_DIR}/"

A=()
bwrap_gui_setup A

A+=(--ro-bind /opt/subs2srs /opt/subs2srs)

bwrap_bind_dir A "$CONF_DIR" "$OUTPUT_DIR"
bwrap_ro_bind_dir A "$MEDIA_DIR"

bwrap_audio A
bwrap_fcitx A

A+=(--chdir "$CONF_DIR")

bwrap_gui_finish A x11 no

exec bwrap "${A[@]}" -- /usr/bin/mono /opt/subs2srs/subs2srs.exe "$@"
