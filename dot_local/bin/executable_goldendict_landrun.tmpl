#!/usr/bin/env bash
# File: ~/.local/bin/goldendict (chezmoi template)
# Sandboxed GoldenDict-ng via landrun (Landlock)
# Note: GoldenDict-ng doesn't support native Wayland, runs via XWayland
set -euo pipefail

UID2="$(id -u)"
XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/${UID2}}"

{{ $s := output "sops" "-d" (joinPath .chezmoi.sourceDir "secrets.enc.yaml") | fromYaml -}}
DICT_DIR_RAW="{{ index $s "goldendict" "dict_dir" }}"
DICT_DIR="$(realpath -m -- "${DICT_DIR_RAW}")"

if [[ ! -d "${DICT_DIR}" ]]; then
  echo "Dictionary directory does not exist: ${DICT_DIR}" >&2
  exit 1
fi

mkdir -p \
  "${HOME}/.config/goldendict" \
  "${HOME}/.local/share/goldendict" \
  "${HOME}/.cache/fontconfig"

ARGS=(
  # ── System ──
  --rox /usr
  --ro  /etc
  --ro  /sys
  --ro  /proc
  --rw  /dev
  --rw  /tmp

  # ── Runtime ──
  --rw  "${XDG_RUNTIME_DIR}"
  --rw  /run/dbus

  # ── App data (read-write) ──
  --rw  "${HOME}/.config/goldendict"
  --rw  "${HOME}/.local/share/goldendict"
  --rw  "${HOME}/.cache/fontconfig"

  # ── Dictionaries (read-only) ──
  --ro  "${DICT_DIR}"

  # ── Environment variables ──
  --env HOME
  --env USER
  --env LANG=en_US.UTF-8
  --env LC_ALL=en_US.UTF-8
  --env PATH=/usr/bin:/bin
  --env XDG_RUNTIME_DIR
  --env XDG_CACHE_HOME="${HOME}/.cache"
  --env QT_QPA_PLATFORMTHEME=qt6ct

  # ── XWayland / X11 (GoldenDict-ng не поддерживает нативный Wayland) ──
  --env DISPLAY="${DISPLAY:-:0}"
  --env QT_QPA_PLATFORM=xcb
)

# X11 auth
if [[ -n "${XAUTHORITY:-}" ]]; then
  ARGS+=(--ro "${XAUTHORITY}" --env XAUTHORITY)
elif [[ -f "${HOME}/.Xauthority" ]]; then
  ARGS+=(--ro "${HOME}/.Xauthority" --env XAUTHORITY="${HOME}/.Xauthority")
fi

# X11 unix socket
[[ -d /tmp/.X11-unix ]] && ARGS+=(--rw /tmp/.X11-unix)

# ── D-Bus ──
[[ -n "${DBUS_SESSION_BUS_ADDRESS:-}" ]] && ARGS+=(--env DBUS_SESSION_BUS_ADDRESS)

# ── Optional read-only paths (themes, fonts, Qt config) ──
for p in \
  "${HOME}/.config/fontconfig" \
  "${HOME}/.config/qt6ct" \
  "${HOME}/.config/qt5ct" \
  "${HOME}/.config/gtk-3.0" \
  "${HOME}/.config/Kvantum" \
  "${HOME}/.local/share/fonts" \
  "${HOME}/.local/share/icons" \
  "${HOME}/.icons"; do
  [[ -e "$p" ]] && ARGS+=(--ro "$p")
done

exec landrun "${ARGS[@]}" -- /usr/bin/goldendict "$@"
