#!/usr/bin/env bash
# Sandboxed neovim via bubblewrap
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

mkdir -p "${HOME}/.local/share/nvim" \
         "${HOME}/.local/state/nvim" \
         "${HOME}/.cache/nvim"

# ── Bind CWD + file arguments ─────────────────────────────────────
FILE_BINDS=()
TMP_BINDS=()

_add_bind() {
    local d="$1"
    case "$d" in /usr/*|/etc/*|/proc/*|/dev/*|/sys/*) return ;; esac
    if [[ "$d" == /tmp* ]]; then
        TMP_BINDS+=(--bind "$d" "$d")
    else
        FILE_BINDS+=(--bind "$d" "$d")
    fi
}

_add_bind "$(realpath "$PWD")"

for arg in "$@"; do
    [[ "$arg" == -* ]] && continue
    if [[ -e "$arg" ]]; then
        _add_bind "$(dirname "$(realpath "$arg")")"
    elif [[ -d "$(dirname "$arg")" ]]; then
        _add_bind "$(realpath "$(dirname "$arg")")"
    fi
done

# ── Wayland clipboard ─────────────────────────────────────────────
WL=()
bwrap_wayland WL

OPT=(); bwrap_lib64 OPT; bwrap_resolv OPT
[[ -d /usr/include ]] && OPT+=(--ro-bind /usr/include /usr/include)

SANDBOX=(); bwrap_sandbox SANDBOX yes

exec bwrap \
    --ro-bind /usr/bin   /usr/bin   \
    --ro-bind /usr/lib   /usr/lib   \
    --ro-bind /usr/share /usr/share \
    "${OPT[@]}" \
    --symlink /usr/bin /bin \
    --symlink /usr/bin /sbin \
    --symlink /usr/lib /lib \
    --proc /proc \
    --dev  /dev \
    --dev-bind /dev/pts /dev/pts \
    --tmpfs /tmp \
    "${TMP_BINDS[@]}" \
    --ro-bind /etc /etc \
    \
    --dir "${HOME}" \
    --dir "${HOME}/.config" \
    --ro-bind "${HOME}/.config/nvim"      "${HOME}/.config/nvim" \
    --bind    "${HOME}/.local/share/nvim" "${HOME}/.local/share/nvim" \
    --bind    "${HOME}/.local/state/nvim" "${HOME}/.local/state/nvim" \
    --bind    "${HOME}/.cache/nvim"       "${HOME}/.cache/nvim" \
    --ro-bind-try "${HOME}/.gitconfig"             "${HOME}/.gitconfig" \
    --ro-bind-try "${HOME}/.config/git"            "${HOME}/.config/git" \
    --bind-try    "${HOME}/.config/nvim/lazy-lock.json" "${HOME}/.config/nvim/lazy-lock.json" \
    --bind-try    "${HOME}/.local/share/chezmoi"   "${HOME}/.local/share/chezmoi" \
    "${FILE_BINDS[@]}" \
    \
    --perms 0700 --dir "${XDG_RUNTIME_DIR}" \
    "${WL[@]}" \
    \
    --setenv HOME  "${HOME}" \
    --setenv TERM  "${TERM}" \
    --setenv LANG  "${LANG:-en_US.UTF-8}" \
    --setenv PATH  "/usr/bin:/bin" \
    --setenv XDG_RUNTIME_DIR "${XDG_RUNTIME_DIR}" \
    ${COLORTERM:+--setenv COLORTERM "$COLORTERM"} \
    \
    "${SANDBOX[@]}" \
    /usr/bin/nvim "$@"
