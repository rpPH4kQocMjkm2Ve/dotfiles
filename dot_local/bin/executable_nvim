#!/usr/bin/env bash
# Sandboxed neovim via bubblewrap
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

mkdir -p "${HOME}/.local/share/nvim" \
         "${HOME}/.local/state/nvim" \
         "${HOME}/.cache/nvim"

FILE_BINDS=(); TMP_BINDS=()

_add_bind() {
    local d="$1"
    case "$d" in /usr/*|/etc/*|/proc/*|/dev/*|/sys/*) return ;; esac
    if [[ "$d" == /tmp* ]]; then
        TMP_BINDS+=(--bind "$d" "$d")
    else
        FILE_BINDS+=(--bind "$d" "$d")
    fi
}

_add_bind "$(realpath "$PWD")"
for arg in "$@"; do
    [[ "$arg" == -* ]] && continue
    if [[ -e "$arg" ]]; then
        _add_bind "$(dirname "$(realpath "$arg")")"
    elif [[ -d "$(dirname "$arg")" ]]; then
        _add_bind "$(realpath "$(dirname "$arg")")"
    fi
done

A=()
bwrap_base A
bwrap_lib64 A
bwrap_resolv A
A+=(--dev-bind /dev/pts /dev/pts
    "${TMP_BINDS[@]}")

A+=(--dir "${HOME}"
    --dir "${HOME}/.config"
    --ro-bind "${HOME}/.config/nvim"                  "${HOME}/.config/nvim"
    --bind    "${HOME}/.local/share/nvim"              "${HOME}/.local/share/nvim"
    --bind    "${HOME}/.local/state/nvim"              "${HOME}/.local/state/nvim"
    --bind    "${HOME}/.cache/nvim"                    "${HOME}/.cache/nvim"
    --ro-bind-try "${HOME}/.gitconfig"                 "${HOME}/.gitconfig"
    --ro-bind-try "${HOME}/.config/git"                "${HOME}/.config/git"
    --bind-try    "${HOME}/.config/nvim/lazy-lock.json" "${HOME}/.config/nvim/lazy-lock.json"
    --bind-try    "${HOME}/.local/share/chezmoi"        "${HOME}/.local/share/chezmoi"
    "${FILE_BINDS[@]}")

bwrap_runtime_dir A
bwrap_wayland A
bwrap_env_base A
A+=(--setenv TERM "${TERM}"
    ${COLORTERM:+--setenv COLORTERM "$COLORTERM"})

bwrap_hardened_malloc A default
bwrap_sandbox A yes

exec bwrap "${A[@]}" -- /usr/bin/nvim "$@"
