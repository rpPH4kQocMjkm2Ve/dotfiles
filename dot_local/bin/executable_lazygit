#!/usr/bin/env bash
# Sandboxed lazygit via bubblewrap
set -euo pipefail
. "${HOME}/.local/lib/bwrap-common.sh"

mkdir -p "${HOME}/.config/lazygit" \
         "${HOME}/.local/state/lazygit"

CWD="$(realpath "$PWD")"

A=()
bwrap_base A
bwrap_lib64 A
bwrap_resolv A

A+=(--dir "${HOME}"
    --dir "${HOME}/.config"
    --dir "${HOME}/.local"
    --dir "${HOME}/.local/share"
    --dir "${HOME}/.local/state"
    --bind "${CWD}" "${CWD}"
    --bind "${HOME}/.config/lazygit"       "${HOME}/.config/lazygit"
    --bind "${HOME}/.local/state/lazygit"  "${HOME}/.local/state/lazygit"
    --ro-bind-try "${HOME}/.gitconfig"     "${HOME}/.gitconfig"
    --ro-bind-try "${HOME}/.config/git"    "${HOME}/.config/git")

bwrap_ssh_agent A

A+=(--perms 0700 --dir "${XDG_RUNTIME_DIR}")

bwrap_env_base A
A+=(--setenv TERM "${TERM}"
    ${COLORTERM:+--setenv COLORTERM "$COLORTERM"})

# no --new-session: lazygit opens /dev/tty, needs controlling terminal
bwrap_hardened_malloc A default
bwrap_sandbox A yes no

exec bwrap "${A[@]}" -- /usr/bin/lazygit "$@"
