#!/bin/sh
# lf previewer: images via kitty icat, video thumbnails via vidthumb,
# text fallback via bat.
#
# Large images are resized to preview pane dimensions before streaming
# to avoid hitting tty buffer limits with --transfer-mode=stream.

draw() {
    src="$1"
    resized="/tmp/lf_preview.png"

    # Approximate preview pane pixel dimensions from cell count
    pw=$((w * 10))
    ph=$((h * 20))

    # Resize to preview pane dimensions and convert to PNG for kitty's
    # native format. The ">" flag only shrinks, never enlarges.
    if command -v magick >/dev/null 2>&1 &&
       magick "$src" -auto-orient -resize "${pw}x${ph}>" "PNG8:$resized" 2>/dev/null &&
       [ -s "$resized" ]; then
        src="$resized"
    fi

    kitten icat --stdin no --transfer-mode stream \
        --place "${w}x${h}@${x}x${y}" "$src" </dev/null >&3
    rm -f "$resized"
    perl -MPOSIX -e 'POSIX::tcdrain(3)'
    exit 1
}

file="$1"
w="$2"
h="$3"
x="$4"
y="$5"

case "$(file -Lb --mime-type "$file")" in
    image/*)
        draw "$file"
        ;;
    video/*)
        # vidthumb generates and caches a thumbnail for the video
        # https://raw.githubusercontent.com/duganchen/kitty-pistol-previewer/main/vidthumb
        draw "$(~/.config/lf/vidthumb "$file")"
        ;;
esac

bat --color=always --style=plain --line-range=:"$h" --terminal-width="$w" "$file" 2>/dev/null ||
    file -b "$file"
